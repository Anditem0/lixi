<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>L√¨ X√¨ B√≠nh Ng·ªç 2026</title>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Be+Vietnam+Pro:wght@400;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>L√å X√å B√çNH NG·ªå 2026 üßß</h1>
  <div id="status-text" class="instruction">Ch·∫°m v√†o bao l√¨ x√¨ ƒë·ªÉ m·ªü v·∫≠n may! (Tap m√†n h√¨nh l·∫ßn ƒë·∫ßu ƒë·ªÉ m·ªü √¢m thanh n·∫øu c·∫ßn)</div>
  <div class="grid" id="grid"></div>
  <button id="reset-btn">L√ÄM M·ªöI B·ªò V√â</button>

  <div id="modal-overlay">
    <div class="modal">
      <h2 id="modal-title" style="color:var(--bright-red); margin:0"></h2>
      <p id="modal-msg" style="font-weight:bold; font-size: 1.1rem; margin:15px 0"></p>
      <button onclick="nextRound()">TI·∫æP T·ª§C</button>
    </div>
  </div>

  <script>
    const PRIZES = [
      { val: 10000, title: "L·ªòC NH·ªé", weight: 60, type: 'small' },
      { val: 20000, title: "NI·ªÄM VUI", weight: 20, type: 'medium' },
      { val: 50000, title: "MAY M·∫ÆN", weight: 12, type: 'medium' },
      { val: 100000, title: "QU√Å NGON", weight: 5, type: 'large' },
      { val: 200000, title: "ƒê·∫†I L·ªòC", weight: 2, type: 'large' },
      { val: 500000, title: "√îNG HO√ÄNG", weight: 1, type: 'jackpot' }
    ];
    const WISHES = [
      "V·∫°n S·ª± Nh∆∞ √ù", "Ph√°t T√†i Ph√°t L·ªôc", "S·ª©c Kh·ªèe D·ªìi D√†o", "An Khang Th·ªãnh V∆∞·ª£ng",
      "Cung h·ª∑ ph√°t t√†i", "Ph√∫c l·ªôc ƒë·∫ßy nh√†", "B√¨nh an m·∫°nh kh·ªèe", "T√¢n ni√™n ƒë·∫°i c√°t"
    ];
    let isAnyCardActive = false;

    // File nh·∫°c c·ª•c b·ªô
    const flipSound = new Audio('nhactet.mp3');
    flipSound.volume = 0.7;

    // Unlock audio (d√πng touchend + click ƒë·ªÉ t∆∞∆°ng th√≠ch mobile t·ªët h∆°n)
    let audioUnlocked = false;
    function unlockAudio() {
      if (audioUnlocked) return;
      audioUnlocked = true;
      console.log('ƒêang th·ª≠ m·ªü kh√≥a √¢m thanh...');
      flipSound.currentTime = 0;
      flipSound.volume = 0;
      flipSound.play()
        .then(() => {
          flipSound.pause();
          flipSound.currentTime = 0;
          flipSound.volume = 0.7;
          console.log('√Çm thanh ƒë√£ m·ªü kh√≥a th√†nh c√¥ng!');
        })
        .catch(e => {
          console.error('L·ªói m·ªü kh√≥a √¢m thanh:', e.message);
          console.log('Ki·ªÉm tra: File nhactet.mp3 c√≥ t·ªìn t·∫°i kh√¥ng? ƒê∆∞·ªùng d·∫´n ƒë√∫ng?');
        });
    }

    // G·∫Øn s·ª± ki·ªán unlock (touchend t·ªët h∆°n touchstart tr√™n mobile)
    document.body.addEventListener('touchend', unlockAudio, { once: true, passive: true });
    document.body.addEventListener('click', unlockAudio, { once: true });

    function createCard(container, wish) {
      const prizeObj = (() => {
        let total = PRIZES.reduce((sum, p) => sum + p.weight, 0);
        let rand = Math.random() * total;
        for (let p of PRIZES) {
          if (rand < p.weight) return p;
          rand -= p.weight;
        }
        return PRIZES[0];
      })();

      const wrapper = document.createElement('div');
      wrapper.className = 'card-container';
      wrapper.innerHTML = `
        <div class="card-inner">
          <div class="card-front">
            <div class="corner top-left"></div>
            <div class="corner bottom-right"></div>
            <div class="emblem">üßß</div>
            <div class="year-text">2026</div>
            <div style="font-size:0.7rem; color:var(--gold); margin-top:5px; font-weight:bold;">CH√öC M·ª™NG NƒÇM M·ªöI</div>
          </div>
          <div class="card-back">
            <div class="card-content">
              <div style="font-size:0.7rem; font-weight:bold; color:#8b0000">L·ªòC XU√ÇN</div>
              <div class="amount">${prizeObj.val.toLocaleString()}ƒë</div>
            </div>
            <canvas width="165" height="235"></canvas>
          </div>
        </div>
      `;

      const canvas = wrapper.querySelector('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      let isDrawing = false, isCleared = false;

      function drawCover() {
        const grd = ctx.createLinearGradient(0, 0, 165, 235);
        grd.addColorStop(0, '#f1c40f'); grd.addColorStop(1, '#d4af37');
        ctx.fillStyle = grd; ctx.fillRect(0, 0, 165, 235);
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.font = '24px "Great Vibes", cursive'; ctx.fillStyle = '#8b0000';
        const words = wish.split(' ');
        ctx.fillText(words.slice(0, Math.ceil(words.length/2)).join(' '), 82, 90);
        ctx.fillText(words.slice(Math.ceil(words.length/2)).join(' '), 82, 130);
        ctx.font = 'bold 10px Arial'; ctx.fillText('C√ÄO V√ôNG TRUNG T√ÇM', 82, 200);
      }
      document.fonts.ready.then(drawCover);

      wrapper.onclick = () => {
        if (isAnyCardActive || wrapper.classList.contains('flipped')) return;
        isAnyCardActive = true;
        wrapper.classList.add('flipped');
        document.querySelectorAll('.card-container').forEach(c => c !== wrapper && c.classList.add('locked'));
        
        flipSound.currentTime = 0;
        flipSound.play().catch(e => console.error('L·ªói ph√°t √¢m thanh flip:', e));
        
        drawCover();
      };

      wrapper.ontouchstart = (e) => {
        e.preventDefault();
      };

      wrapper.ontouchend = (e) => {
        if (isAnyCardActive || wrapper.classList.contains('flipped')) return;
        isAnyCardActive = true;
        wrapper.classList.add('flipped');
        document.querySelectorAll('.card-container').forEach(c => c !== wrapper && c.classList.add('locked'));
        
        flipSound.currentTime = 0;
        flipSound.play().catch(e => console.error('L·ªói ph√°t √¢m thanh flip (touchend):', e));
        
        drawCover();
      };

      function scratch(e) {
        if (!isDrawing || isCleared || !wrapper.classList.contains('flipped')) return;
        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        const x = (clientX - rect.left) * (canvas.width / rect.width);
        const y = (clientY - rect.top) * (canvas.height / rect.height);
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath(); ctx.arc(x, y, 25, 0, Math.PI * 2); ctx.fill();
        const imgData = ctx.getImageData(30, 80, 100, 70);
        let clear = 0;
        for (let i = 3; i < imgData.data.length; i += 4) if (imgData.data[i] === 0) clear++;
        if (clear > (imgData.data.length / 4) * 0.8) {
          isCleared = true;
          canvas.style.transition = "opacity 0.6s"; canvas.style.opacity = '0';
          setTimeout(() => {
            canvas.remove();
            shootFireworks(prizeObj.type);
            document.getElementById('modal-title').innerText = prizeObj.title;
            document.getElementById('modal-msg').innerText = `B·∫°n nh·∫≠n ƒë∆∞·ª£c ${prizeObj.val.toLocaleString()}ƒë!`;
            document.getElementById('modal-overlay').style.display = 'flex';
          }, 400);
        }
      }

      canvas.onmousedown = () => isDrawing = true;
      canvas.ontouchstart = (e) => { isDrawing = true; e.preventDefault(); };
      window.onmouseup = () => isDrawing = false;
      window.ontouchend = () => isDrawing = false;
      canvas.onmousemove = scratch;
      canvas.ontouchmove = (e) => { scratch(e); e.preventDefault(); };

      container.appendChild(wrapper);
    }

    function shootFireworks(type) {
      const colors = ['#f1c40f', '#e74c3c', '#ffffff', '#ff9f43'];
      if (type === 'small') confetti({ particleCount: 40, spread: 50, origin: { y: 0.7 } });
      else if (type === 'medium') confetti({ particleCount: 120, spread: 80, origin: { y: 0.6 } });
      else if (type === 'large') confetti({ particleCount: 300, spread: 120, origin: { y: 0.6 }, scalar: 1.2, colors });
      else if (type === 'jackpot') {
        const end = Date.now() + 5000;
        (function frame() {
          confetti({ particleCount: 20, angle: 60, spread: 100, origin: { x: 0, y: 0.6 }, colors, scalar: 1.4 });
          confetti({ particleCount: 20, angle: 120, spread: 100, origin: { x: 1, y: 0.6 }, colors, scalar: 1.4 });
          confetti({ particleCount: 25, angle: 90, spread: 160, origin: { x: 0.5, y: 0.7 }, colors, scalar: 1.6 });
          if (Date.now() < end) requestAnimationFrame(frame);
        }());
      }
    }

    function nextRound() {
      document.getElementById('modal-overlay').style.display = 'none';
      isAnyCardActive = false;
      document.querySelectorAll('.card-container').forEach(c => {
        if (!c.querySelector('canvas')) {
          c.style.opacity = "0.2";
          c.style.pointerEvents = "none";
        } else {
          c.classList.remove('locked');
        }
      });
    }

    function start() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      isAnyCardActive = false;
      let shuffled = [...WISHES].sort(() => Math.random() - 0.5);
      for (let i = 0; i < 6; i++) createCard(grid, shuffled[i]);
    }

    document.getElementById('reset-btn').onclick = start;
    start();
  </script>
</body>
</html>
